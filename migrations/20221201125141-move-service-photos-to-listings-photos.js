'use strict';

var dbm;
var type;
var seed;

/**
  * We receive the dbmigrate dependency from dbmigrate initially.
  * This enables us to not have to rely on NODE_PATH.
  */
exports.setup = function(options, seedLink) {
  dbm = options.dbmigrate;
  type = dbm.dataType;
  seed = seedLink;
};

exports.up = function(db) {
  return db.runSql(`
    INSERT INTO listing_has_photos(listing_id, photo_id, created_at, updated_at, resource_id)
    SELECT services.listing_id, service_has_photos.photo_id, service_has_photos.created_at, service_has_photos.updated_at, service_has_photos.resource_id
    FROM service_has_photos
    INNER JOIN services ON service_has_photos.service_id = services.id;
    ALTER TABLE service_has_photos DROP CONSTRAINT service_has_photos_photo_id_fk;
    ALTER TABLE service_has_photos DROP CONSTRAINT service_has_photos_service_id_fk;
    DROP TABLE IF EXISTS service_has_photos;
  `)
};

exports.down = function(db) {
  return db.runSql(`
    CREATE TABLE public.service_has_photos (
    id integer primary key generated by default as identity,
    service_id int NOT NULL,
    photo_id int NOT NULL,
    created_at timestamp NOT NULL DEFAULT NOW(),
    updated_at timestamp NOT NULL DEFAULT NOW(),
    resource_id varchar(10485760) NOT NULL,
    CONSTRAINT service_has_photos_resource_id_uq UNIQUE (resource_id),
    CONSTRAINT service_has_photos_service_id_photo_id_uq UNIQUE (service_id, photo_id),
    CONSTRAINT service_has_photos_service_id_fk FOREIGN KEY (service_id) REFERENCES public.services(id),
    CONSTRAINT service_has_photos_photo_id_fk FOREIGN KEY (photo_id) REFERENCES public.photos(id)
    );
    INSERT INTO service_has_photos(service_id, photo_id, created_at, updated_at, resource_id)
    SELECT services.id, listing_has_photos.photo_id, listing_has_photos.created_at, listing_has_photos.updated_at, listing_has_photos.resource_id
    FROM listing_has_photos
    INNER JOIN services ON listing_has_photos.listing_id = services.listing_id;
  `)
};

exports._meta = {
  "version": 1
};
